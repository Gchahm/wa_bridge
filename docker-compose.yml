services:
  whatsapp:
    build: ./whatsapp-api
    restart: unless-stopped
    network_mode: host
    environment:
      - MESSAGE_WEBHOOK_URL=${WA_MESSAGE_WEBHOOK_URL}
      - VOICE_WEBHOOK_URL=${WA_VOICE_WEBHOOK_URL}
      - LISTEN_ADDR=${WA_LISTEN_ADDR}
      - DATABASE_URL=${WA_DATABASE_URL}
      - SUPABASE_URL=${WA_SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${WA_SUPABASE_SERVICE_KEY}
    tty: true
    stdin_open: true
    logging:
      driver: grafana/loki-docker-driver:latest
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-batch-size: "100"
        loki-retries: "3"
        labels: "service"
        loki-external-labels: "container={{.Name}}"

  n8n:
    image: n8nio/n8n:latest
    restart: unless-stopped
    network_mode: host
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=${N8N_DB_HOST}
      - DB_POSTGRESDB_PORT=${N8N_DB_PORT}
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME}
      - DB_POSTGRESDB_USER=${N8N_DB_USER}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - DB_POSTGRESDB_SCHEMA=n8n
      - DB_POSTGRESDB_SSL_ENABLED=${N8N_DB_SSL_ENABLED}
      - N8N_PORT=${N8N_PORT}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL}
    volumes:
      - n8n_data:/home/node/.n8n

  loki:
    image: grafana/loki:3.4.2
    restart: unless-stopped
    network_mode: host
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./loki/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki_data:/loki

  grafana:
    image: grafana/grafana:11.5.2
    restart: unless-stopped
    network_mode: host
    environment:
      - GF_SERVER_HTTP_PORT=3200
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - LOKI_URL=http://localhost:3100
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana

volumes:
  n8n_data:
  loki_data:
  grafana_data:
